<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• –ú–æ–π –ß–∞—Ç</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        header {
            background: linear-gradient(to right, #4776E6, #8E54E9);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        header h1 {
            font-size: 24px;
            cursor: pointer;
        }
        
        /* –°–¢–ò–õ–ò –î–õ–Ø –í–•–û–î–ê */
        .auth-panel {
            padding: 30px;
        }
        .auth-panel h2 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }
        .auth-panel input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        .auth-panel input:focus {
            outline: none;
            border-color: #4776E6;
        }
        
        /* –ö–ù–û–ü–ö–ò */
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-primary {
            background: linear-gradient(to right, #4776E6, #8E54E9);
            color: white;
        }
        .btn-secondary {
            background: linear-gradient(to right, #00b09b, #96c93d);
            color: white;
        }
        .btn-guest {
            background: linear-gradient(to right, #f97316, #f59e0b);
            color: white;
        }
        .btn-link {
            background: transparent;
            color: #666;
            text-decoration: underline;
        }
        
        /* –û–ü–¶–ò–ò –í–•–û–î–ê */
        .auth-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            font-size: 14px;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            color: #666;
        }
        .checkbox-label input {
            width: auto;
            margin-right: 8px;
            margin-bottom: 0;
        }
        .auth-link {
            color: #4776E6;
            text-decoration: none;
        }
        .auth-link:hover {
            text-decoration: underline;
        }
        
        /* –†–ê–ó–î–ï–õ–ò–¢–ï–õ–¨ */
        .divider {
            text-align: center;
            margin: 20px 0;
            color: #999;
            position: relative;
        }
        .divider::before {
            content: "";
            position: absolute;
            left: 0;
            top: 50%;
            width: 45%;
            height: 1px;
            background: #ddd;
        }
        .divider::after {
            content: "";
            position: absolute;
            right: 0;
            top: 50%;
            width: 45%;
            height: 1px;
            background: #ddd;
        }
        
        /* –ì–û–°–¢–¨ */
        .guest-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .chat-section {
        /* –ß–ê–¢ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç) */
            display: none;
            flex-direction: column;
            height: 500px;
        }
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f5f7fb;
        }
        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 15px;
            margin-bottom: 10px;
            word-wrap: break-word;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message.sent {
            background: linear-gradient(to right, #4776E6, #8E54E9);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        .message.received {
            background: white;
            border: 1px solid #e0e0e0;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        
        /* –í–í–û–î –°–û–û–ë–©–ï–ù–ò–Ø */
        .input-area {
            display: flex;
            padding: 15px;
            gap: 10px;
            background: white;
            border-top: 1px solid #eee;
        }
        #messageInput {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 20px;
            font-size: 16px;
        }
        #messageInput:focus {
            outline: none;
            border-color: #4776E6;
        }
        #sendBtn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(to right, #4776E6, #8E54E9);
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        
        /* –°–¢–ê–¢–£–° */
        .status {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            color: #666;
            font-size: 14px;
            border-top: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üî• –ú–æ–π –ß–∞—Ç</h1>
        </header>
        
        <!-- –ü–ê–ù–ï–õ–¨ –í–•–û–î–ê -->
        <div class="auth-panel" id="authPanel">
            <h2>–í—Ö–æ–¥ –≤ —á–∞—Ç</h2>
            
            <!-- –§–û–†–ú–ê –í–•–û–î–ê -->
            <div id="loginForm">
                <input type="text" id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
                <div class="auth-options">
                    <label class="checkbox-label">
                        <input type="checkbox" id="rememberMe">
                        <span>–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</span>
                    </label>
                    <a href="#" id="showRegister" class="auth-link">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                </div>
                <button id="loginBtn" class="btn btn-primary">üîê –í–æ–π—Ç–∏</button>
            </div>
            
            <!-- –§–û–†–ú–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò (—Å–∫—Ä—ã—Ç–∞) -->
            <div id="registerForm" style="display: none;">
                <input type="text" id="regUsername" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –∏–º—è">
                <input type="password" id="regPassword" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
                <input type="password" id="regPasswordConfirm" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                <button id="registerBtn" class="btn btn-secondary">üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <button id="showLogin" class="btn btn-link">‚Üê –ù–∞–∑–∞–¥ –∫–æ –≤—Ö–æ–¥—É</button>
            </div>
            
            <!-- –ì–û–°–¢–¨ -->
            <div class="guest-section">
                <div class="divider">–∏–ª–∏</div>
                <input type="text" id="guestName" placeholder="–ë—ã—Å—Ç—Ä–æ–µ –∏–º—è –¥–ª—è –≥–æ—Å—Ç—è">
                <button id="guestLogin" class="btn btn-guest">üéÆ –í–æ–π—Ç–∏ –∫–∞–∫ –ì–æ—Å—Ç—å</button>
            </div>
        </div>
        
        <!-- –°–ï–ö–¶–ò–Ø –ß–ê–¢–ê (—Å–∫—Ä—ã—Ç–∞ –¥–æ –≤—Ö–æ–¥–∞) -->
        <div class="chat-section" id="chatSection">
            <div class="messages" id="messages"></div>
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                <button id="sendBtn" disabled>‚û§</button>
            </div>
            <div class="status" id="status">
                <span id="onlineCount">1</span> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–Ω–ª–∞–π–Ω
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
// ===== –ö–û–ù–§–ò–ì FIREBASE =====
const firebaseConfig = {
    apiKey: "AIzaSyBGfP59ZHQgMT8yTXfuGDcYqZADGl1haqg",
    authDomain: "chat-online-12.firebaseapp.com",
    projectId: "chat-online-12",
    storageBucket: "chat-online-12.firebasestorage.app",
    messagingSenderId: "503074236144",
    appId: "1:503074236144:web:01694517bc7210f5708435"
};

// ===== –û–°–ù–û–í–ù–û–ô –ö–û–î =====
try {
    const app = firebase.initializeApp(firebaseConfig);
    console.log("‚úÖ Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω");
    
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let currentUser = null;
    let username = "";
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const authPanel = document.getElementById('authPanel');
    const chatSection = document.getElementById('chatSection');
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const onlineCount = document.getElementById('onlineCount');
    
    // ===== –ü–†–û–°–¢–ê–Ø –°–ò–°–¢–ï–ú–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò =====
    function simpleHash(password) {
        let hash = 0;
        for (let i = 0; i < password.length; i++) {
            hash = ((hash << 5) - hash) + password.charCodeAt(i);
            hash = hash & hash;
        }
        return Math.abs(hash).toString(16);
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–æ—Ä–º
    document.getElementById('showRegister').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
    });
    
    document.getElementById('showLogin').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('loginForm').style.display = 'block';
    });
    
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    document.getElementById('registerBtn').addEventListener('click', function() {
        const regUsername = document.getElementById('regUsername').value.trim();
        const regPassword = document.getElementById('regPassword').value;
        const regPasswordConfirm = document.getElementById('regPasswordConfirm').value;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∏
        if (!regUsername || regUsername.length < 3) {
            alert('–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 3 —Å–∏–º–≤–æ–ª–æ–≤');
            return;
        }
        
        if (!regPassword || regPassword.length < 4) {
            alert('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 4 —Å–∏–º–≤–æ–ª–æ–≤');
            return;
        }
        
        if (regPassword !== regPasswordConfirm) {
            alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
            return;
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
        const users = JSON.parse(localStorage.getItem('chat_users') || '{}');
        
        if (users[regUsername]) {
            alert('–≠—Ç–æ –∏–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ!');
            return;
        }
        
        users[regUsername] = {
            password: simpleHash(regPassword),
            created: new Date().toISOString()
        };
        
        localStorage.setItem('chat_users', JSON.stringify(users));
        
        alert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ');
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –≤—Ö–æ–¥
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('loginForm').style.display = 'block';
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
        document.getElementById('username').value = regUsername;
        document.getElementById('password').value = regPassword;
    });
    
    // –í—Ö–æ–¥ –ø–æ –ø–∞—Ä–æ–ª—é
    document.getElementById('loginBtn').addEventListener('click', async function() {
        const name = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const rememberMe = document.getElementById('rememberMe').checked;
        
        if (!name || !password) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –ø–∞—Ä–æ–ª—å');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const users = JSON.parse(localStorage.getItem('chat_users') || '{}');
        const user = users[name];
        
        if (!user) {
            alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        if (user.password !== simpleHash(password)) {
            alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
            return;
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if (rememberMe) {
            localStorage.setItem('chat_saved_name', name);
        }
        
        // –í—Ö–æ–¥–∏–º –≤ —á–∞—Ç
        username = name;
        await enterChat();
    });
    
    // –ì–æ—Å—Ç–µ–≤–æ–π –≤—Ö–æ–¥
    document.getElementById('guestLogin').addEventListener('click', async function() {
        const guestName = document.getElementById('guestName').value.trim() || "–ì–æ—Å—Ç—å";
        const name = guestName.length > 20 ? guestName.substring(0, 20) : guestName;
        
        if (name.length < 3) {
            alert('–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 3 —Å–∏–º–≤–æ–ª–æ–≤');
            return;
        }
        
        username = name + " (–ì–æ—Å—Ç—å)";
        await enterChat();
    });
    
    // ===== –í–•–û–î –í –ß–ê–¢ =====
    async function enterChat() {
        console.log("–í—Ö–æ–∂—É –∫–∞–∫:", username);
        
        try {
            // –í—Ö–æ–¥–∏–º –≤ Firebase –∞–Ω–æ–Ω–∏–º–Ω–æ
            const userCredential = await auth.signInAnonymously();
            currentUser = userCredential.user;
            
            console.log("‚úÖ –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω!");
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ —á–∞—Ç
            authPanel.style.display = 'none';
            chatSection.style.display = 'flex';
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.focus();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            loadMessages();
            
            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –æ–Ω–ª–∞–π–Ω
            trackOnlineUsers();
            
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:", error);
            alert("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —á–∞—Ç—É");
        }
    }
    
    // ===== –ó–ê–ì–†–£–ó–ö–ê –°–û–û–ë–©–ï–ù–ò–ô =====
    function loadMessages() {
        console.log("–ó–∞–≥—Ä—É–∂–∞—é —Å–æ–æ–±—â–µ–Ω–∏—è...");
        
        db.collection('messages')
            .orderBy('timestamp', 'asc')
            .limit(50)
            .onSnapshot(snapshot => {
                messagesDiv.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    addMessage(msg.username, msg.text, msg.userId === currentUser?.uid);
                });
                
                // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
    }
    
    // ===== –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø =====
    async function sendMessage() {
        const text = messageInput.value.trim();
        if (!text || !currentUser) return;
        
        try {
            await db.collection('messages').add({
                text: text,
                username: username,
                userId: currentUser.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            messageInput.value = '';
            messageInput.focus();
            
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", error);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ");
        }
    }
    
    // ===== –î–û–ë–ê–í–õ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø –ù–ê –≠–ö–†–ê–ù =====
    function addMessage(sender, text, isOwn) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isOwn ? 'sent' : 'received'}`;
        messageDiv.innerHTML = `<strong>${sender}:</strong> ${text}`;
        messagesDiv.appendChild(messageDiv);
        
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    // ===== –û–ù–õ–ê–ô–ù –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò =====
    function trackOnlineUsers() {
        if (!currentUser) return;
        
        const userRef = db.collection('onlineUsers').doc(currentUser.uid);
        
        // –û—Ç–º–µ—á–∞–µ–º —Å–µ–±—è –æ–Ω–ª–∞–π–Ω
        userRef.set({
            username: username,
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // –£–¥–∞–ª—è–µ–º –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
        window.addEventListener('beforeunload', () => {
            userRef.delete();
        });
        
        // –°–ª—É—à–∞–µ–º –¥—Ä—É–≥–∏—Ö
        db.collection('onlineUsers').onSnapshot(snapshot => {
            onlineCount.textContent = snapshot.size;
        });
    }
    
    // ===== –°–û–ë–´–¢–ò–Ø =====
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    sendBtn.addEventListener('click', sendMessage);
    
    // ===== –ê–í–¢–û-–í–•–û–î –ü–†–ò –°–û–•–†–ê–ù–Å–ù–ù–û–ú –ò–ú–ï–ù–ò =====
    window.addEventListener('load', function() {
        const savedName = localStorage.getItem('chat_saved_name');
        if (savedName) {
            document.getElementById('username').value = savedName;
            document.getElementById('rememberMe').checked = true;
            document.getElementById('password').focus();
        }
    });
    
    console.log("‚ú® –ß–∞—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!");
    
} catch (error) {
    console.error("üí• –û—à–∏–±–∫–∞:", error);
    alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞");
}
    </script>
</body>
    </html> 
